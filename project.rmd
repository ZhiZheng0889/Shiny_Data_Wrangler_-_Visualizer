---
title: "R Notebook"
output: html_notebook
---

```{r}
#install.packages(c("shiny", "tidyverse", "readxl", "haven", "readr"))

library(shiny)
library(tidyverse)
library(readxl)    
library(haven)     
library(readr)     
library(shinyjs)

# Custom Mode Function
calculate_mode <- function(x) {
  uniqx <- unique(x)
  uniqx[which.max(tabulate(match(x, uniqx)))]
}
```

```{r}
# UI Definition
ui <- fluidPage(
    useShinyjs(),
    titlePanel("Interactive Data Analysis App with Data Handling"),
    sidebarLayout(
        sidebarPanel(
            selectInput("dataset_choice", "Choose Dataset", choices = c("airquality")),
            hr(),
            h4("Data Handling Options"),

            # Universal Columns Selector
            selectInput("selected_cols", "Select Columns", choices = NULL, multiple = TRUE),

            # Data Filtering UI
            checkboxInput("enable_filter", "Enable Data Filtering", FALSE),
            textInput("filter_condition", "Enter filter condition (e.g., `Ozone > 30`)"),

            # Data Transformation UI
            checkboxInput("enable_transformation", "Enable Data Transformation", FALSE),
            selectInput("transformation_method", "Select Transformation Method", 
                        choices = c("None", "Min-Max Scaling", "Z-Score Standardization", "Log Transformation")),

            # Missing Data Handling UI
            checkboxInput("handle_missing", "Handle Missing Values", FALSE),
            radioButtons("missing_method", "Method", choices = c("Mean", "Median", "Mode", "Omit")),
            
            actionButton("update_data", "Update Data"),
            actionButton("clear_cols", "Clear Column Selection"),
            actionButton("exit_app", "Exit App")
        ),
        mainPanel(
            h4("Data Preview"),
            tableOutput("data_preview"),
            h4("Missing Data Summary"),
            tableOutput("missing_summary")  # Display for missing data summary
        )
    )
)


```

```{r}
# Server Logic
server <- function(input, output, session) {
    # Load the dataset
    dataset <- reactive({
        req(input$dataset_choice)
        switch(input$dataset_choice,
               "airquality" = airquality)
    })

    # Reactive value for the updated dataset
    updated_dataset <- reactiveVal()

    # Function to count missing values in each column
    count_missing <- function(data) {
        data %>% summarise(across(everything(), ~sum(is.na(.)))) %>% pivot_longer(cols = everything(), names_to = "Column", values_to = "MissingCount")
    }

    # Reactive values for missing data summary
    missing_summary_before <- reactiveVal()
    missing_summary_after <- reactiveVal()

    # Update column choices
    observe({
        columns <- names(dataset())
        updateSelectInput(session, "selected_cols", choices = columns)
    })

    # Observe Update Data button click
    observeEvent(input$update_data, {
        data <- dataset()
        cols <- input$selected_cols

        # Capture missing data summary before handling
        missing_summary_before(count_missing(data))

        # Data Filtering with Dynamic Condition
        if (input$enable_filter && input$filter_condition != "") {
            for (col in cols) {
                condition <- paste0("`", col, "`", input$filter_condition)
                tryCatch({
                    data <- data %>% filter(!!rlang::parse_expr(condition))
                }, error = function(e) {
                    print(paste("Error in filter condition for column", col, ":", e$message))
                    return(NULL)  # Return NULL to stop further processing
                })
            }
        }

        # Check if data is NULL after error in filtering
        if (is.null(data)) return()

        # Data Transformation
        if (input$enable_transformation && input$transformation_method != "None") {
            data <- switch(input$transformation_method,
                   "Min-Max Scaling" = { data %>% mutate(across(all_of(cols), ~ (. - min(.)) / (max(.) - min(.)))) },
                   "Z-Score Standardization" = { data %>% mutate(across(all_of(cols), ~ (scale(.) %>% as.vector))) },
                   "Log Transformation" = { data %>% mutate(across(all_of(cols), log)) }
            )
        }

        # Missing Data Handling
        if (input$handle_missing) {
            tryCatch({
                if (input$missing_method == "Omit") {
                    data <- data %>% filter(complete.cases(.[cols]))
                } else {
                    data <- data %>% mutate(across(all_of(cols), function(x) {
                        if (input$missing_method == "Mean" || input$missing_method == "Median") {
                            if (is.numeric(x)) {
                                if (input$missing_method == "Mean") {
                                    replace_na(x, mean(x, na.rm = TRUE))
                                } else if (input$missing_method == "Median") {
                                    replace_na(x, median(x, na.rm = TRUE))
                                }
                            } else {
                                x  # Return column unchanged if it's not numeric
                            }
                        } else if (input$missing_method == "Mode") {
                            # Replace with mode - define calculate_mode function if needed
                            mode_val <- calculate_mode(x[!is.na(x)])
                            replace_na(x, mode_val)
                        } else {
                            x
                        }
                    }))
                }

                updated_dataset(data)
                missing_summary_after(count_missing(data))
            }, error = function(e) {
                print(paste("Error in missing data handling:", e$message))
            })
        } else {
            updated_dataset(data)
        }
    })

    # Output for missing data summary
    output$missing_summary <- renderTable({
        req(input$show_missing)  # Render only when show_missing is true
        summary_before <- missing_summary_before()
        summary_after <- missing_summary_after()
        if (!is.null(summary_before) && !is.null(summary_after)) {
            summary_combined <- summary_before %>%
                                left_join(summary_after, by = "Column", suffix = c("_Before", "_After"))
            summary_combined
        } else {
            data.frame()  # Return empty dataframe if summaries are null
        }
    })

    # Output for data preview
    output$data_preview <- renderTable({
        if (!is.null(updated_dataset())) {
            head(updated_dataset(), 10)
        } else {
            head(dataset(), 10)
        }
    })

    # Exit button functionality
    observeEvent(input$exit_app, {
        stopApp()
    })
}

```


```{r}
shinyApp(ui = ui, server = server)

```

